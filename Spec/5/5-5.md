### 5.4 雰囲気の抽選処理

本節では、イベント発生時に同時に決定される「雰囲気（mood）」に関する抽選仕様を記述する。雰囲気は感情ラベルの変化確率やセリフ傾向などに影響する、短期的な会話の空気・トーンを表す指標である。

#### 5.4.1 雰囲気ラベル定義

雰囲気は整数値（-2〜+2）で内部管理され、以下のように定義される。

| 値  | 英語ラベル           | 日本語ラベル   | 出力傾向           |
| -- | --------------- | -------- | -------------- |
| 2  | `very_positive` | とてもポジティブ | 明るく親しみやすい、安心感  |
| 1  | `positive`      | ポジティブ    | 穏やかで前向き        |
| 0  | `neutral`       | 普通       | 中立、自然体         |
| -1 | `negative`      | ネガティブ    | 疲労感、違和感、よそよそしさ |
| -2 | `very_negative` | とてもネガティブ | 張り詰めた空気、不安、冷たさ |

* 内部的には数値で保存・参照されるが、UIやログでは日本語表示に変換される
* セリフトーンや感情ラベル変化補正に影響を与える（詳細は5.5節）

#### 5.4.2 雰囲気の抽選タイミングと処理概要

* 雰囲気はイベント発生時に1回だけ抽選される（イベント単位）
* 抽選結果はそのイベント中のみ有効（継続しない）
* 抽選に用いるパラメータは以下：

  * 関係ラベル（relation\_label）
  * 感情ラベル（emotion\_label） ※主にA→B視点
  * 好感度（affection）
  * 信頼度（trust） ※プレイヤー介入イベント時

#### 5.4.3 雰囲気決定の処理フロー（概要）

1. キャラクターの関係性・感情ラベル・好感度などをもとに、候補となる雰囲気値（-2〜+2）ごとの**出現比率テーブル**を取得
2. 好感度や感情ラベルに応じて補正処理を適用（例：好感度が高いと -2 が出にくくなる）
3. 重みに基づき1つの雰囲気値を確率的に抽選し、イベントに紐づける

#### 5.4.4 出現比率テーブル例

以下は「関係：友達、感情：気になる、好感度50」の組み合わせに対する一例：

```json
{
  "-2": 5,
  "-1": 10,
  "0": 40,
  "1": 30,
  "2": 15
}
```

※ 実際の出現比率は、イベント種別やキャラクター性格等によってさらに補正される場合がある。

#### 5.4.5 プレイヤー介入イベントでの特例

プレイヤーが関与する「困りごと」イベントにおいては、雰囲気の決定に **キャラ→プレイヤーの信頼度（trust）** が加味される。

* 信頼度が高い場合： `1`, `0`（ポジティブ〜普通） に寄りやすい
* 信頼度が低い場合： `-2`, `-1`（とてもネガティブ〜ネガティブ） に寄りやすい

#### 5.4.6 実装上の備考

* 雰囲気は `mood: -2 ～ +2` の形式で保存される（英語ラベルは補助的）
* 出力・ログ表示・UIでは対応する日本語ラベルが表示される
* 雰囲気値は `5.5 感情ラベルの抽選` における変化率補正にも用いられる
* 雰囲気に応じたセリフトーン補正は今後のプロンプト調整にて反映予定