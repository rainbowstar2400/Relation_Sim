### 5.5 雰囲気の抽選処理

本節では、イベント発生時に同時に決定される「雰囲気（mood）」に関する抽選仕様を記述する。雰囲気は感情ラベルの変化確率やセリフ傾向などに影響する、短期的な会話の空気・トーンを表す指標である。

#### 5.5.1 雰囲気ラベル定義

雰囲気は整数値（-2〜+2）で内部管理され、以下のように定義される。

| 値  | 英語ラベル           | 日本語ラベル   | 出力傾向           |
| -- | --------------- | -------- | -------------- |
| 2  | `very_positive` | とてもポジティブ | 明るく親しみやすい、安心感  |
| 1  | `positive`      | ポジティブ    | 穏やかで前向き        |
| 0  | `neutral`       | 普通       | 中立、自然体         |
| -1 | `negative`      | ネガティブ    | 疲労感、違和感、よそよそしさ |
| -2 | `very_negative` | とてもネガティブ | 張り詰めた空気、不安、冷たさ |

* 内部的には数値で保存・参照されるが、UIやログでは日本語表示に変換される
* セリフトーンや感情ラベル変化補正に影響を与える（詳細は5.6節）

#### 5.5.2 雰囲気の抽選タイミングと処理概要

* 雰囲気はイベント発生時に1回だけ抽選される（イベント単位）
* 抽選結果はそのイベント中のみ有効（継続しない）
* 抽選に用いるパラメータは以下：

  * 関係ラベル（relation\_label）
  * 感情ラベル（emotion\_label） ※主にA→B視点
  * 好感度（affection）

#### 5.5.3 抽選処理の流れ

##### 1. 平均好感度の算出

* キャラクターA→B、B→A の片方向好感度を取得し、\*\*平均値（四捨五入）\*\*を求める。

  ```js
  const affectionAvg = Math.round((affAtoB + affBtoA) / 2);
  ```

##### 2. 雰囲気中心値（baseMood）の決定

* 以下の閾値により、中心となる雰囲気値（baseMood）を決定：

| 平均好感度    | baseMood |
| -------- | -------- |
| -100～-30 | -2       |
| -30～0    | -1       |
| 0～30     | 0        |
| 30～60    | 1        |
| 61～100   | 2        |

##### 3. 初期分布テーブルの取得

* 中心値に対応する **雰囲気分布（未補正）** を取得（initial_distribution_table.json）。例：

```json
{
  "-2": 10,
  "-1": 20,
  "0": 40,
  "1": 20,
  "2": 10
}
```

* 各中心値には固定の分布が用意されており、合計値は任意（通常100）。

##### 4. 補正係数の取得

* **関係ラベル** に対応する補正係数ベクトル（5つの倍率）を取得（relation_modifier_table.jaon）：

  ```json
  { "-2": 1.0, "-1": 1.0, "0": 1.0, "1": 1.0, "2": 1.0 }
  ```
* **感情ラベル（A→B および B→A）** それぞれに対応する補正ベクトルを取得（emotion_modifier_table.json）：

  ```json
  emotionA: { "-2": 1.2, "-1": 1.1, "0": 1.0, "1": 0.8, "2": 0.6 },
  emotionB: { "-2": 1.2, "-1": 1.1, "0": 1.0, "1": 0.8, "2": 0.6 }
  ```

##### 5. 補正の適用と正規化

* 初期分布に、関係ラベル補正・感情ラベル補正（両方向）を掛けた重みで新しい分布を得る：

```js
for (let mood = -2; mood <= 2; mood++) {
    corrected[mood] = base[mood]
                    * relationCoeff[mood]
                    * emotionCoeffA[mood]
                    * emotionCoeffB[mood];
}
```

* 最後に `corrected` を正規化して抽選用比率を得る。

##### 6. 雰囲気の抽選

* 正規化された重みに基づき、`-2～2` のいずれかを**重み付きランダムで1つ抽選**する。
* 抽選された値は、そのイベントの雰囲気値として使用され、セリフ生成や感情ラベル変化に影響を与える。

#### 5.5.4 実装上の備考

* 雰囲気は `mood: -2 ～ +2` の形式で保存される（英語ラベルは補助的）
* 出力・ログ表示・UIでは対応する日本語ラベルが表示される
* 雰囲気値は `5.6 感情ラベルの抽選` における変化率補正にも用いられる
* 雰囲気に応じたセリフトーン補正は今後のプロンプト調整にて反映予定
* 雰囲気値は**イベント単位で一度だけ決定され、永続しない**。

#### 5.5.5 補正係数の定義フォーマット（JSON例）

```json
"relation_table": {
  "恋人": { "-2": 0.7, "-1": 0.9, "0": 1.0, "1": 1.2, "2": 1.3 },
  "友達": { "-2": 1.0, "-1": 1.0, "0": 1.0, "1": 1.0, "2": 1.0 },
  ...
},
"emotion_table": {
  "気まずい": { "-2": 1.2, "-1": 1.1, "0": 1.0, "1": 0.8, "2": 0.6 },
  "好きかも": { "-2": 0.8, "-1": 0.9, "0": 1.0, "1": 1.1, "2": 1.2 },
  ...
}
```