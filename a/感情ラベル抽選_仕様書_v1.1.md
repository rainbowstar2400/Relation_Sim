# 📘 感情ラベル変化抽選仕様書（v1.1）

## 🧭 概要

本仕様は、非関与イベント（例：雑談、思い出し会話、二人きりの時間）発生時に実行される、キャラクター間の**感情ラベル変化の抽選処理**に関する設計を定める。

---

## 🔁 抽選のトリガー

- 対象イベント：**プレイヤー非関与イベント**（雑談／思い出し会話／二人きり など）
- 対象：イベントに参加したすべてのキャラペア（A→B, B→A）

---

## 🧩 感情ラベルの定義と遷移構造

### 通常関係（友達など）

```
「嫌いかも」 ← 「なし」 → 「気になる」 → 「好きかも」
```

- 「気になる」は一定期間接触がなければ「なし」に自然リセット
- 「好きかも」「嫌いかも」はイベントがなければ変化しない（固定）

### 特別関係（恋人・親友・家族）

```
「嫌い」 ← 「普通」 ← 「好き」（初期値） → 「大好き」
```

- 「好き」が初期ラベル
- 「大嫌い」イベントにより「別れたい」イベントが発生（プレイヤー関与型）

### 特殊ラベル「気まずい」

- すべての関係ラベル・感情ラベルから遷移可能
- 「気まずい」→他感情 も含めて抽選対象
- 自然リセットあり（「気になる」と同様）

---

## 🎲 抽選方式の基本

### イベントグループ化

- 抽選処理において、次のイベントはすべて同一カテゴリとして扱う：

```
[雑談, 思い出し会話, 二人きりの時間]
→ 内部的には同一のイベント種別キー（例："non_involved_conversation"）として処理
```

### 抽選ロジック

- 抽選は `(イベント種別, 関係ラベル, 現在の感情ラベル, 変化先ラベル)` をキーとする補間関数により実行される。

```python
key = ("non_involved_conversation", 関係ラベル, 現在の感情ラベル, 変化先ラベル)
probability = interpolation_functions[key](好感度)
```

```python
if random() < (probability / 100):
    感情ラベル = 変化先ラベル
```

---

## 📐 抽選確率の設計方針

- 好感度に対して**線形補間**を行うことで柔軟な確率制御が可能。
- 通常は好感度=20, 50, 80程度をベースに定義（将来的に任意数値へ拡張可）
- イベントが起きても「約7割は変化しない」確率設計
- 出力内容や感情変化の妥当性を保ちつつ、過剰な変化を防ぐバランス設計

---

## 📄 データ形式（CSV構造）

### 必須列構成（例）

| イベント種別           | 関係ラベル | 現在の感情 | 変化先ラベル | 好感度=20 | 好感度=50 | 好感度=80 |
|------------------------|------------|-------------|----------------|------------|------------|------------|
| non_involved_conversation | 友達       | なし         | 気になる        | 10         | 20         | 35         |

- 同一イベント種であれば省略行もOK（ffillで補完）
- 読み込み後に `scipy.interpolate.interp1d` などで補間関数を生成

---

## 🔚 抽選処理（擬似コード）

```python
for each キャラA, B in イベント参加者:
    current_label = get_emotion_label(A→B)
    affection = get_affection_score(A→B)

    for target_label in valid_transitions_from(current_label):
        key = ("non_involved_conversation", relationship_label, current_label, target_label)
        prob = interpolation_functions[key](affection)

        if random() < prob / 100:
            set_emotion_label(A→B, target_label)
```

---

## 💬 備考

- 自然リセット（接触なし一定期間で感情ラベルリセット）は別仕様にて定義予定
- SYSTEMログへの出力は任意（例：「SYSTEM: 感情ラベルが『好きかも』に変化しました」）
- プレイヤー関与イベントでの変化処理は本仕様とは分離
