### 5.1 イベント発生抽選

この節では、キャラクター間で自動的に発生する非介入型イベント（雑談・挨拶・思い出し・二人きり等）の抽選処理について記述する。

#### 5.1.1 候補ペアの生成ルール

非介入型イベントは、対象となる**キャラクターのペア**をあらかじめ生成し、その上でイベント種別を選定し、最終的に抽選・実行される。

##### 対象ペアの生成条件：

* **共通条件（全イベント種別共通）**

  * 両者ともに状態が「就寝中」「風邪」等の制限状態でないこと
  * 両者ともに**初期設定済みであり、削除フラグが立っていないこと**

* **種別ごとの補正条件**

  * 「雑談イベント」：関係ラベルが「友達」「親友」「恋人」「家族」
  * 「挨拶イベント」：関係ラベルが「なし」「認知」「友達」「親友」「恋人」「家族」
  * 「思い出し会話イベント」：関係ラベルが「友達」「親友」「恋人」「家族」
  * 「二人きりの時間イベント」：関係ラベルが「友達」「親友」「恋人」「家族」

##### ペアの生成方法（例）：

全キャラクターの中から、条件を満たす順序付きペア（A→B）を列挙。
ペア数が多すぎる場合は、一定数（例：上限20ペア）までに絞り込み。

#### 5.1.2 イベント種別の選定ロジック

対象ペアごとに発生可能なイベント種別を抽出し、その中から一つを選定する。

##### 優先度設定（例）：

| イベント種別 | 優先度 | 備考                     |
| ------ | --- | ---------------------- |
| 挨拶     | 高   | 接触の起点となるイベント           |
| 雑談     | 中   | ランダム性ありつつ頻出            |
| 二人きり  | 低   |  |
| 思い出し会話   | 低   |   |

※ただし、優先度は「発生率」ではなく「候補として選ばれる順序」を意味する。

#### 5.1.3 発生確率の調整要因

最終的なイベント抽選において、以下の要素が発生確率に影響する：

* キャラ同士の関係ラベル（親しさが高いほど会話イベントが発生しやすい）
* 好感度（片方向が極端に低いと発生率が下がる）
* 性格パラメータ（社交性が高いキャラほど雑談が多く、行動力が高いキャラほど発端役になりやすい）
* 感情ラベルの状態（「嫌いかも」「気まずい」などを持っていると抽選の重みが大きく減衰する）
* 時間帯（朝や夜間など、キャラの活動傾向に応じて補正）

#### 5.1.4 発生抑制条件と制限

以下のような状況では、イベント発生が**抑制または禁止**される：

* 同一のキャラが前回イベントから一定時間が経過していない（連続イベント抑制）
* 同一のペアで直前にイベントが発生していた
* 他の重要イベント（プレイヤー介入イベントなど）が画面上で処理中

#### 5.1.5 実装設計と補足情報

非介入型イベントの抽選処理は、以下のような構成で実装される。

##### 関数構成（擬似コード）

```ts
function runEventCycle() {
  const pairs = generateCandidatePairs();
  const candidates = evaluateEventCandidates(pairs);
  const selected = drawFromCandidates(candidates);
  if (selected) {
    applyEvent(selected);
  }
}
```

##### 補正要素と評価項目

各イベント候補には以下の情報が付与され、最終的な重みとして評価される：

* `baseRate`：イベント種別ごとの基本優先度（例：雑談=5、思い出し会話=8）
* `modifiers`：補正係数。以下の要因を考慮する：

  * 好感度（低すぎる場合は減衰）
  * 感情ラベル（「嫌いかも」「気まずい」→重みが大きく減衰）
  * 性格（社交性・行動力）
  * 時間帯と活動傾向の一致

##### 抽選処理

評価されたイベント候補群に対して重み付き乱数抽選を行い、1件を選出する。

```ts
function drawFromCandidates(candidates): Candidate | null {
  const weighted = candidates.map(c => ({
    ...c,
    weight: calculateFinalWeight(c.baseRate, c.modifiers)
  }));
  return weighted.length > 0 ? weightedRandomChoice(weighted) : null;
}
```

##### イベント発生処理

抽選されたイベントは以下の処理を伴って実行される：

* GPT出力によるセリフ生成（プロンプトは別仕様）
* 好感度の固定上昇（+1〜+3など）
* 感情ラベルの変化抽選（別仕様）
* ログ出力（`EVENT:`／`SYSTEM:`）の記録

##### その他補足

* 補正値や重みは定数管理で調整可能にしておく
* 将来的に「イベント雰囲気（ポジティブ／ネガティブ）」による分岐演出に対応可能
* 同一ペア連続イベントを避ける履歴保持処理なども実装可能
