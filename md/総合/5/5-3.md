### 5.3 プレイヤー介入イベント（困りごと）の生成

この節では、画面内に一時的に表示される「困りごと」相談イベントの生成および管理に関する内部処理仕様を記述する。これらはプレイヤーが選択または入力で対応することで完了し、信頼度などの変化を引き起こす。

#### 5.3.1 イベント生成タイミングと頻度

##### 自動生成のタイミング：

* ゲーム内時間と同期し、**約1時間ごと**に生成処理を試行
* 画面に既に表示されている相談が**存在しない場合**に限り、新規生成される
* 生成処理は1回につき**1件のみ**

##### 同時発生の制限：

* 複数の相談が**同時に画面上に表示されることはない**
* 既存のイベントがプレイヤーに無視されている間は、次の生成は行われない

#### 5.3.2 対象キャラクターの選定条件

困りごとの発信者となるキャラクターは、以下の条件をすべて満たす必要がある。

##### 必須条件：

* 状態が「就寝中」「風邪」などでない
* 直近1時間以内に他の困りごとイベントを発生させていない

##### 補正条件：

* **信頼度が高いほど発生確率が上昇**
* 外交性・表現力が高いキャラクターは選ばれやすい傾向

#### 5.3.3 内容の選択と形式

プレイヤー介入イベントで表示される「困りごと」は、テンプレート化された相談文をもとに構成される。テンプレートは、形式と深さの2軸で分類される。

##### 1） テンプレートの分類と形式

テンプレートは以下の2形式に分類される：

| 種別   | 内容形式        | プレイヤー操作    |
| ---- | ----------- | ---------- |
| 選択式  | 2～3択のうちから選ぶ | ボタンで回答     |
| 穴埋め式 | 一部が空欄の文章    | キーボード入力で補完 |

形式はテンプレートごとに固定されており、イベント生成時に形式を混在させることはない。

##### 2） 信頼度によるテンプレート出現制御

テンプレートは「深さ（レベル）」と呼ばれる分類を持ち、信頼度に応じて出現可能なテンプレートのレベル範囲が変化する。

1. **テンプレートの深さ（Lv）と信頼度の関係**

テンプレートには以下の4段階の深さがある：

| レベル | 内容の傾向                |
| --- | -------------------- |
| Lv0 | 表面的・日常的・雑談的な話題       |
| Lv1 | やや内面・感情に踏み込む話題       |
| Lv2 | 感情的・自己に関わる話題         |
| Lv3 | 打ち明け・将来・対人関係に関わる深い相談 |

出現するレベルは信頼度によって制御され、以下のように段階的に解放される：

| 信頼度  | 抽選候補となるレベル | 出現比率（例）                               |
| ---- | ---------- | ------------------------------------- |
| 0〜20 | Lv0 のみ     | 100% Lv0                              |
| +40  | Lv0〜Lv2    | 60% Lv0 / 30% Lv1 / 10% Lv2           |
| +80  | Lv0〜Lv3    | 25% Lv0 / 45% Lv1 / 25% Lv2 / 5% Lv3  |
| +100 | Lv0〜Lv3    | 15% Lv0 / 40% Lv1 / 30% Lv2 / 15% Lv3 |

テンプレートごとのレベル分類は別途データファイル内に定義されており、実際の抽選処理ではこの出現比率に基づいて候補が選ばれる。

2. **低信頼度専用テンプレートの出現**

信頼度が 20 以下の場合、通常のテンプレートは出現せず、**低信頼度専用テンプレート**が選出対象となる。

* 使用されるテンプレートはジャンルA〜Eに限定される（感情・打ち明け系は除外）
* 内容は雑談風を装いつつも、プレイヤーへの距離感・懐疑・戸惑いをにじませた構成
* 表現トーンは「丁寧だが理知的な皮肉」「観察者視点の問いかけ」「上位存在性への違和感」など

3. **トーン指定との連携（補足）**

テンプレートのレベルや信頼度は、生成されるセリフの雰囲気にも影響を及ぼす。セリフ生成時には、以下のような `tone_tag` が付与される：

```json
{
  "to_player": {
    "trust_level": 87,
    "recognition_stage": "trust",
    "tone_tag": "trusting_friendly",
    "style_modifiers": ["emotive"]
  }
}
```

これにより、同一テンプレートでも信頼度の違いによって話し方や印象が変化するように制御される。

#### 5.3.4 回答後の処理と自動消滅

##### プレイヤーが回答した場合：

* 該当キャラが「ありがとう！」などの返答を行い、信頼度変動（上昇 or 停止）を伴って終了
* 回答内容によって信頼度が変化するが、数値は**その場では表示されない**
* ログに「SYSTEM: 〇〇からの信頼度が上昇しました。」等を出力

##### プレイヤーが無視した場合：

* 表示から**約1時間経過後に自動消滅**
* 特別なログ出力は行われない

---

このように、プレイヤー介入イベントは**リアルタイム性と選択一回性を重視**した構成とし、UI上でも自然に表示・終了するように設計されている。